:docname: 【次期TICK】1分足生成（BP-03）処理設計書
:lang: ja
:doctype: book
:toc: left
:toclevels: 3
:toc-title: 目次
:sectnums: 1
:sectnumlevels: 6
:icons: font

:table-caption: 表
:figure-caption: 図
:example-caption: 例
//HTML化するときに画像を埋め込む
:data-uri:
//:imagesdir：../images

= 【次期TICK】1分足生成（BP-03）処理設計書
:author: (株)QUICK ITインフラ本部
:revnumber: 1.0

= 変更履歴

[cols="1,1,1,3a", options="header"]
|===
|版数
|変更日
|変更者
|変更内容
  
|第1.0版
|
|タオ
|ドキュメント作成
|===

== はじめに

=== 目的
本ドキュメントは、【次期TICK】１分足データ生成プロセスの詳細設計について記述する。

=== 関連システム等
[cols="1,2,3", options="header"]
|===
|No
|名称
|格納場所

|{counter:ka}
|BP03_処理概要書.adoc
|https://drive.google.com/drive/folders/1LzDW8A9r61I37ZE8Zq_Dd7dLxZKsSDce[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_処理フロー図.drawio.svg
|https://drive.google.com/drive/folders/1JANZTDFWQbW6ODimy-a2j9le-qTZ2vqF[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_処理定義書.xlsx
|https://drive.google.com/drive/folders/1JCGVCStogJuJKQgpvsGjtc519EEEZE1p[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_処理フロー詳細図.drawio.svg
|https://drive.google.com/drive/folders/1msP0Wd6L6zAsQoXPepixMR0AKri38SXL[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_インタフェース設計書.xlsx
|https://drive.google.com/drive/folders/1dE_BnWKyekVXnq0JVTzOMZNaO4vd5eui[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_外部変数定義書.xlsx
|https://drive.google.com/drive/folders/1JBGLpqh_7GUGlQDCbEnGIwQAptHDQZSF[Google Drive, window=\"_blank\"]

|{counter:ka}
|BP03_メッセージ定義一覧.xlsx
|https://drive.google.com/drive/folders/1i_GOhKmh0MoP1hGCb1K7uRyhC_FsZtVV[Google Drive, window=\"_blank\"]

|{counter:ka}
|DB設計
|https://drive.google.com/drive/folders/1AbvnZz3rTw1JaJbI_kPGC2eD3q7mDd_i[Google Drive, window=\"_blank\"]

|===


== 環境定義
=== 入出力定義

以下に入出力概要図を示す。

image::images/入出力概要図.drawio.svg[title="入出力概要図",align="center"]

==== 入力
入力には以下のものがある。

[cols="1,4,2,2,2", options="header"]
|===
|No
|名称
|作成元
|種類
|入力元

|{counter:tbl1}
|外部変数定義ファイル
|-
|ファイル
|ローカル

|{counter:tbl1}
|蓄積対象エレメント
|-
|ファイル
|S3 

|{counter:tbl1}
|1分足対象エレメント
|-
|ファイル
|ローカル

|{counter:tbl1}
|要素の算出式
|-
|ファイル
|ローカル

|{counter:tbl1}
|データ取得・登録テンプレート
|-
|ファイル
|ローカル

|{counter:tbl1}
|１分足再生成要求メッセージ
|-
|ファイル
|S3

|{counter:tbl1}
|共有情報定義ファイル
|-
|ファイル
|S3

|{counter:tbl1}
|論理グループ定義ファイル（最優良気配用）
|-
|ファイル
|S3

|{counter:tbl1}
|最優良気配データ
|DB蓄積
|DB
|TICKデータベース

|{counter:tbl1}
|マネーフローデータ
|DB蓄積
|DB
|TICKデータベース

|{counter:tbl1}
|オプションデータ
|DB蓄積
|DB
|TICKデータベース

|{counter:tbl1}
|指数用売買関連データ
|DB蓄積
|DB
|TICKデータベース

|{counter:tbl1}
|日中足管理
|DB蓄積
|DB
|TICKデータベース

|===

==== 出力
出力には以下のものがある。

[cols="1,3,2,2", options="header"]
|===
|No
|名称
|種類
|出力先

|{counter:tbl2}
|1分足データ
|DB
|TICKデータベース

|{counter:tbl2}
|日中足管理データ
|DB
|TICKデータベース

|{counter:tbl2}
|アプリケーションログ
|ログ
|S3

|===

==== 起動パラメータ
起動パラメータは環境変数として設定する +

. 1分足生成の場合、パラメータ： +
.. TK_TARGET_KEI：対象系（例：1）
.. TK_OPERATION_TYPE：要求種別（値：0）
.. TK_TKQKBN：QUOTE区分（例：E）
.. TK_SNDC：発信元（例：T）
.. TK_CREATE_DATE：作成基準日（例：20220727）
.. TK_CREATE_TIME：作成時刻（例：12:00）
.. TK_START_INDEX：固有名（１バイト目終了）（例：1）
. 1分足訂正の場合、パラメータ： +
.. TK_TARGET_KEI：対象系（例：1）
.. TK_OPERATION_TYPE：要求種別（値：1）
.. TK_FOLDER_PATH：訂正要求ファイルのフォルダパス（例：TOOL02_20220413_1604000000）


== メイン関数

image::images/マイン.drawio.svg[title="マイン関数",align="center"]

=== 関数一覧
[cols="1,4,5",width="90%",options="header"]
|===
|No
|ファンクション名
|処理名

|{counter:lisst}
|main
|マイン
|===

=== 処理内容
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func main()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|
|
|

|
|
|

|
|
|


1+.^|*機能*
3+|プログラムを起動し、主な処理を実行する。
|===

. 環境変数から「TK」から始まる変数の値を取得する。変数一覧は以下の変数を含む：
.. TK_TARGET_KEI
.. TK_OPERATION_TYPE
.. TK_TKQKBN
.. TK_SNDC
.. TK_CREATE_DATE
.. TK_CREATE_TIME
.. TK_FOLDER_PATH
.. TK_START_INDEX

. リクエストパラメータをチェックする処理を行う。
.. エラーが発生する場合、エラーログ（ERR001）を出力して、異常に終了する。
.. エラーが発生しない場合、次の処理を行う。

. 初期処理を行う。
.. エラーが発生する場合、エラーログ（ERR008）を出力して、異常に終了する。
.. エラーが発生しない場合、次の処理を行う。

. 「1」に取得された変数をconfigオブジェクトに以下のように格納する。
.. TargetKei = TK_TARGET_KEI
.. OperationType = TK_OPERATION_TYPE
.. Kubun = TK_TKQKBN
.. Hassin = TK_SNDC
.. CreateDay = TK_CREATE_DATE
.. CreateTime = TK_CREATE_TIME
.. FolderPath = TK_FOLDER_PATH
.. QuoteCodeStartIndex = TK_START_INDEX

. AWSインフラを初期化する
.. 成功の場合、次の処理を続ける
.. 失敗の場合、ログ（ERR007）を作成し出力し、異常に修了する。

. データ生成・更新処理を行う。
.. エラーが発生する場合、エラーログ（ERR009）を出力して、異常に終了する。
.. エラーが発生しない場合、通常に終了する。

== リクエストパラメータをチェックする処理（validateParameters）

image::images/パラメータをチェック.drawio.svg[title="リクエストパラメータをチェック",align="center"]

=== 関数一覧
[cols="1,4,5",width="90%",options="header"]
|===
|No
|ファンクション名
|処理名

|{counter:validateParameters}
|validateParameters
|リクエストパラメータをチェック

|===

=== 処理内容
リクエストパラメータをチェックする

. エラーが発生する場合、プログラムを異常に終了する +
. エラーが発生しない場合、次の処理を行う。

=== 関数詳細
==== リクエストパラメータをチェック（validateParameters）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func validateParameters()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|parameters
|リクエストパラメータ一覧

|O
|err
|エラーステータス

|
|
|

1+.^|*機能*


3+|リクエストパラメータ一覧をチェックする。
|===

要求種別（TK_OPERATION_TYPE）の値をチェックする：

. 対象系（TK_TARGET_KEI）をチェックする：
.. 対象系が1と2ではない場合、エラーログ（ERR003）を出力して、異常に終了する。
.. 対象系が1又は2の場合、次の処理を行う。

. 要求種別が0の場合：
.. QUOTE区分（TK_TKQKBN）をチェックする：
... QUOTE区分の長さが > 2の場合、エラーログ（ERR003）を出力して、異常に終了する。
... QUOTE区分の長さが ≤ 2の場合、処理1.cを行う。
..  発信元（TK_SNDC）をチェックする：
... 発信元の長さが > 5の場合、エラーログ（ERR003）を出力して、異常に終了する。
... 発信元の長さが ≤ 5の場合、処理1.dを行う。
..  固有名（１バイト目終了）（TK_START_INDEX）をチェックする
... 固有名の長さが = 0の場合、エラーログ（ERR003）を出力して、異常に終了する。
... 固有名のの長さが > 0の場合、起動処理を行う。
..  作成基準日（TK_CREATE_DATE）をチェックする
... 作成基準日のフォーマットがYYYY/MM/DDではない場合、エラーログ（ERR003）を出力して、異常に終了する。
... 作成基準日のフォーマットがYYYY/MM/DDの場合、処理1.eを行う。
..  作成時刻（TK_CREATE_TIME）をチェックする
... 作成時刻のフォーマットがHH:MMではない場合、エラーログ（ERR003）を出力して、異常に終了する。
... 作成時刻のフォーマットがHH:MMの場合、処理1.fを行う。



. 要求種別が1の場合：
..  訂正要求ファイルのフォルダパス（TK_FOLDER_PATH）をチェックする
... フォルダパスの長さが > 0の場合、エラーログ（ERR003）を出力して、異常に終了する。
... フォルダパスのの長さが = 0の場合、起動処理を行う。

. 要求種別が0と1ではない場合： +
エラーログ（ERR002）を出力して、異常に終了する。

== 起動処理（initConfig）

image::images/起動処理.drawio.svg[title="起動処理",align="center"]

=== 関数一覧
[cols="1,4,5",width="90%",options="header"]
|===
|No
|ファンクション名
|処理名

|{counter:init}
|initConfig
|外部定義ファイルをロードして、メモリに格納し、データベースを接続する。

|===

=== 処理内容
プログラムを起動し、定義ファイルをロードしてメモリに格納し、TICK　データベースを接続する。

=== 関数詳細

==== 起動処理（initConfig）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func initConfig()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|O
|err
|エラーステータス

|
|
|

|
|
|

1+.^|*機能*
3+|プログラムを起動し、外部定義ファイルを読み込み、情報を格納して、Quote区分と発信元を元に該当データベースエンドポイントを判定する。
|===

. 外部変数定義ファイルを読み込んで、JSON型をオブジェクト型へ変換を行う。Quote区分と発信元を元に該当データベースエンドポイントを判定する。
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する。
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く。

== サーバをスタートする処理（Start）
image::images/サーバをスタート.drawio.svg[title="サーバをスタート",align="center"]

=== 関数一覧
[cols="1,4,5",width="90%",options="header"]
|===
|No
|ファンクション名
|処理名

|{counter:ServerStart}
|Start
|サーバをスタート

|{counter:ServerStart}
|StartCreateProcess
|1分足生成

|{counter:ServerStart}
|StartUpdateDataProcess
|1分足訂正（エレメント訂正の場合）

|{counter:ServerStart}
|StartUpdateQuoteCodeProcess
|1分足訂正（QUOTEコード訂正の場合）

|===

=== 処理内容
対象データ生成期間と対象QUOTEコード一覧を取得して、データ生成処理を行う。

=== 関数詳細

==== サーバをスタートする処理（Start）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func Start()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|O
|err
|エラーステータス

|
|
|

|
|
|

1+.^|*機能*
3+|対象データ生成期間と対象QUOTEコード一覧を取得して、データ生成処理を行う。
|===

. データ取得・登録SQLテンプレートを読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 共有情報定義ファイルのローカルURIを用いて、読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 論理グループ定義ファイル（最優良気配用）と論理グループ定義ファイル（複数気配用）を読み込んで、データベース情報をロードする
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 1分足対象エレメント定義を読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 要求種別をチェックする
.. 要求種別が 0（定期生成）の場合、処理6を行う。
.. 要求種別が 1（臨時訂正）の場合、処理7を行う。

. 1分足データ生成の処理
.. 論理グループ定義ファイル（最優良気配用）からDBエンドポイントとDB名を取得する
... 取得したデータベース情報を元に、データベース接続生成する
... 取得したリトライ条件がループ条件として、ループを開始する
... データベースにpingする
... ループを終了する
... データベースに接続していない状態の場合、エラーログ（ERR004）を出力し、異常に終了する

.. 蓄積対象エレメントファイルのローカルURIを用いて、読み込む
... 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
... 以外場合、すべて内容をメモリに格納する。次の処理に行く

.. 日中足管理テーブルにクエリして、該当レコードの情報を取得する
... レコードがない場合、エラーログ（ERR013）を出力し、異常に終了する
... レコードの作成ステータスが１又は２である場合、ログ（INF004）を出力し、正常に終了する
... レコードの作成ステータスが0又は3である場合、ログ（INF002）を出力し、次の処理を続ける

.. 要素の算出式ファイルを読み込む
... 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
... 以外場合、すべて内容をメモリに格納する。次の処理に行く

.. 区分・発信元・日付を利用して、対象QUOTEコード一覧を取得する
... 失敗場合、エラーログ（ERR006）を出力し、異常に終了する
... 以外場合、すべて内容をメモリに格納する。次の処理に行く

.. *1分足生成処理（StartCreateProcess）* を実行する

. 1分足データ訂正の処理
.. S3フォルダのファイルを読込、訂正情報オブジェクト一覧を作成する
... 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
... 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 機能種別をチェックする +
.. 機能種別が 1（データ訂正）の場合： +
... 取得されたオブジェクト一覧から訂正データの該当区分・発信元を取得する
... 論理グループ定義ファイル（最優良気配用）からDBエンドポイントとDB名を取得する
.... 取得したデータベース情報を元に、データベース接続生成する
.... 取得したリトライ条件がループ条件として、ループを開始する
.... データベースにpingする
.... ループを終了する
.... データベースに接続していない状態の場合、エラーログ（ERR004）を出力し、異常に終了する
... *1分足訂正処理(エレメント訂正の場合)（StartUpdateDataProcess）* を実行する

.. 機能種別が 2（QUOTEコード訂正）の場合、処理7を行う。
... 取得されたオブジェクト一覧から変更前QUOTEコードと変更後QUOTEコードの該当区分・発信元を取得する
... 論理グループ定義ファイル（最優良気配用）からDBエンドポイントとDB名を取得する
.... 取得したデータベース情報を元に、データベース接続生成する
.... 取得したリトライ条件がループ条件として、ループを開始する
.... データベースにpingする
.... ループを終了する
.... データベースに接続していない状態の場合、エラーログ（ERR004）を出力し、異常に終了する
... *1分足訂正処理(QUOTEコード訂正の場合)（StartUpdateQuoteCodeProcess）* を実行する

.. 機能種別が1と2の以外の場合、エラー（ERR010）を出して異常に終了する。

. データ生成が成功した場合、ログ（INF001）を作成し出力する。
. タスクリソースを解放し、ログ（INF005）を作成し出力する。

==== 1分足生成する処理（StartCreateProcess）

image::images/1分足生成.drawio.svg[title="1分足生成",align="center"]

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func StartCreateProcess()

.5+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|Quoteコード一覧
|生成対象Quoteコード一覧

|I
|エレメント算出式定義
|元データと１分足データの関係・計算式を記述する情報

|O
|ERR006のエラー
|SQL文実行処理に失敗したエラー

|O
|ERR019のエラー
|テンプレートロード処理に失敗したエラー

1+.^|*機能*
3+|1分足生成用の関数。
|===
. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す。
.. 作成ステータスを1（作成中）に設定する。
.. 更新日付をシステム日付に設定する。

. *データ生成処理* を実行する。

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す。
.. 作成ステータスを2（作成完了）又は3（作成失敗）に設定する。
.. 更新日付をシステム日付に設定する。

==== 1分足訂正処理 (エレメント訂正の場合)（StartUpdateDataProcess）

image::images/1分足訂正(エレメント訂正の場合).drawio.svg[title="1分足訂正(エレメント訂正の場合)",align="center"]

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func StartUpdateDataProcess()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|O
|err
|エラーステータス

|
|
|

|
|
|

1+.^|*機能*
3+|1分足生成用の関数。
|===
取得された訂正情報オブジェクト一覧をループして、それぞれのオブジェクトに対して、以下の処理を行う：

. 蓄積対象エレメントファイルのローカルURIを用いて、読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 日中足管理テーブルにクエリして、該当レコードの情報を取得する
.. レコードがない場合、エラーログ（ERR013）を出力し、異常に終了する
.. レコードの作成ステータスが「0」ではない場合、通常ログ（INF004）を出力し、異常に終了する
.. レコードの作成ステータスが「0」の場合、通常ログ（INF004）を出力し、異常に終了する

. 対象データ生成期間を「00:00:00 - 23:59:59」に設定する（一日中のデータを訂正する）

. 要素の算出式ファイルを読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 要素の算出式ファイルの中身内容があるかどうか確認する。
.. 有りの場合、次の処理を続ける
.. 無しの場合、処理を修了する。

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す。
.. 作成ステータスを1（作成中）に設定する。
.. 更新日付をシステム日付に設定する。

. *データ生成処理* を実行する。

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す。
.. 作成ステータスを2（作成完了）又は3（作成失敗）に設定する。
.. 更新日付をシステム日付に設定する。

==== 1分足訂正 (QUOTEコード訂正の場合)（StartUpdateQuoteCodeProcess）

image::images/1分足訂正(QUOTEコード訂正の場合).drawio.svg[title="1分足訂正(QUOTEコード訂正の場合)",align="center"]

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func StartUpdateQuoteCodeProcess()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|O
|err
|エラーステータス

|
|
|

|
|
|

1+.^|*機能*
3+|1分足生成用の関数。
|===
取得された訂正情報オブジェクトから、訂正開始日付と訂正終了日付を取得する。訂正開始日付から訂正終了日付までの日数をループして、以下処理を行う：

. 対象データ生成期間を「00:00:00 - 23:59:59」に設定する（一日中のデータを訂正する）

. 蓄積対象エレメントファイルのローカルURIを用いて、読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 取得された訂正情報オブジェクトからのQUOTEコード一覧をループして、以下処理を行う：

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す
.. 作成ステータスを1（作成中）に設定する
.. 更新日付をシステム日付に設定する

. 変更前QUOTEコード用の要素の算出式ファイルを読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 変更前QUOTEコードの現在のデータを削除する
.. 区分・発信元・日付を利用して、QUOTEコードを含むテーブルの存在をチェックする
... テーブルが存在しない場合、エラーログ（ERR014）を出力し、異常に終了する
... 以外場合、次の処理を行う
.. QUOTEコードに該当するデータを削除する
... エラーが発生する場合、エラーログ（ERR006）を出力し、異常に終了する
... 以外場合、次の処理を行う

. 変更前QUOTEコードに対して、*データ生成処理* を実行する

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す
.. 作成ステータスを2（作成完了）又は3（作成失敗）に設定する
.. 更新日付をシステム日付に設定する。

. 変更後QUOTEコード用の要素の算出式ファイルを読み込む
.. 失敗場合、エラーログ（ERR005）を出力し、異常に終了する
.. 以外場合、すべて内容をメモリに格納する。次の処理に行く

. 変更後QUOTEコードに対して、*データ生成処理* を実行する

. 日中足管理テーブルを更新する（UpdateCandleManagementStatus）関数を呼び出す
.. 作成ステータスを2（作成完了）又は3（作成失敗）に設定する
.. 更新日付をシステム日付に設定する。

== データ生成処理

image::images/データ生成.drawio.svg[title="データ生成",align="center"]
	
=== 処理内容
. QUOTEコード一ごとに、1分データ生成スレッドを作成する +
.. 各スレッドに、Work関数を呼び出す
.. Work関数に各QUOTEコードに対して、分の順番で1分データ生成（workPerMinute）処理を行う
.. 1分足生成する（workPerMinute）関数にデータ編集の処理を呼び出す
.. 作成された1分足データをデータ登録・更新スレッドに渡す
. データ登録・更新スレッドを作成する +
1分レコード数量がTK_SYSTEM_BATCH_SIZEになった場合、1分足生成・更新（InsertOneMinuteTable）関数を呼び出すことで、データベースへ1分足データを一括で登録する。

=== 関数一覧
[cols="1,4,5",width="90%",options="header"]
|===
|No
|ファンクション名
|処理名

|{counter:createdata}
|Work
|Quoteコード毎の1分足生成

|{counter:createdata}
|UpdatePerDate
|Quoteコード毎の1分足生成

|{counter:createdata}
|workPerMinute
|1分足生成

|{counter:createdata}
|ProcessHighData
|最大値を取得

|{counter:createdata}
|ProcessLowData
|最小値を取得

|{counter:createdata}
|ProcessOpenData
|始値を取得

|{counter:createdata}
|ProcessCloseData
|終値を取得

|{counter:createdata}
|ProcessSumData
|合計値を取得

|{counter:createdata}
|processDFLAG
|DFlagの値を設定

|{counter:createdata}
|processJFLAG
|JFlagの値を設定

|{counter:createdata}
|processDPPAndDPR
|TickデータDPP、DPRの値を退避・設定

|{counter:createdata}
|InsertOneMinuteTable
|1分足生成・更新

|{counter:createdata}
|UpdateCandleManagementStatus
|日中足管理テーブルを更新
|===

=== 関数詳細

==== 各QUOTEコードの1分足生成する処理（Work）（1分足生成スレッド）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func Work()

.6+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|quoteCode
|QUOTEコード

|I
|startTime
|開始時刻秒

|I
|endTime
|終了時刻秒

|I
|mappingColumn
|mappingカラム

|I
|suffixName
|suffix名


1+.^|*機能*
3+|1分足を生成して、1分足データを1分足登録・更新スレッドに渡す。
|===
. データ生成対象の期間に分の順番でループする。
. 1分足生成する処理（workPerMinute）を行う。

==== 日単位の1分足生成する処理（UpdatePerDate）（1分足生成スレッド）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func UpdatePerDate()

.3+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|quoteCodes
|QUOTEコード一覧

|I
|createDay
|生成対象日付

1+.^|*機能*
3+|1分足を生成して、1分足データを1分足登録・更新スレッドに渡す。
|===
. データ生成対象の期間に分の順番でループする。
. 1分足生成する処理（workPerMinute）を行う。

==== 1分足生成する処理（workPerMinute）

image::images/１分間処理.drawio.svg[title="１分間処理",align="center"]

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func workPerMinute()

.5+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*


|I
|minute
|対象分

|I
|QUOTECode
|対象QUOTEコード

|I
|listAllData
|取得されたTICKデータ

|O
|err
|エラーステータス

1+.^|*機能*
3+|1分足を生成して、1分足データを1分足登録・更新スレッドに渡す。
|===
. １分足データのエレメント一覧を取得する。この一覧は生成対象となる。
. 各エレメントに対して、１分足データのメインエレメントを生成するスレッドを作成する。複数の作成スレッドを同時に展開可能である。エレメントの処理は以下の通りである。
.. 対象エレメントに対して、算出式を判定する
... 始値の場合、始値を算出する（ProcessOpenData）
... 高値の場合、高値を算出する（ProcessHighData）
... 安値の場合、安値を算出する（ProcessLowData）
... 終値の場合、終値を算出する（ProcessCloseData）
... 合計値の場合、合計値を算出する（ProcessSumData）
. １分足データ登録かどうか確認する
.. 登録する場合、次の処理を続ける
.. 登録しない場合、修了する
. JFlagを処理する（ProcessJFLAG）
. 他エレメントを処理する（ProcessSpecialColumn）
. １分足データをＤＢへ登録する

==== 1分足編集する処理
以下の処理を含む： 

[cols="1,1,3", options="header"]
|===

^|関数名
^|編集方法
^|関数内容

|ProcessHighData
|HIGH
|時刻ポケット内の最大値をリターンする

|ProcessLowData
|LOW
|時刻ポケット内の最小値をリターンする

|ProcessOpenData
|OPENING
|時刻ポケット内の始値をリターンする

|ProcessCloseData
|CLOSING
|時刻ポケット内の終値をリターンする

|ProcessSumData
|SUM
|時刻ポケット内の合計値をリターンする

|processDFLAG
|-
|DFLAGをリターンする。

|processJFLAG
|-
|JFLAGをリターンする。

|processDPPAndDPR
|-
|DPP・DPRを設定する処理。

|===

===== 最大値を取得する処理（ProcessHighData）

[cols="1,1,2,4", options="header"]
|===
3+|関数ファイル名(定義位置)
1+|なし

3+|関数プロトタイプ宣言ファイル名(参照)
1+|なし

1+|形式
3+|func ProcessHighData()

.6+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|listAllData
|QUOTEコードに該当する全てのデータ

|I
|columnData
|DPP、DPR等

|I
|columnTime
|TIME、DPP_T等

|O
|data
|出力データ（高値）

|O
|err
|エラーステータス

1+.^|*機能*
3+|最大値をリターンする。
|===
. listAllDataをループして、columnTimeの時刻項目でcolumnData項目の最大値を取得する
.. 処理中のアイテムの時刻と処理対象時刻を比較し、対象かどうか判断する。
... 対象の場合、次の処理を続ける
... 対象外の場合、次のループを続ける
.. 処理中のデータを変換する
... 変換済データがNULLではない場合、次の処理を続ける
... 変換済データがNULLである場合、次のループを続ける
.. 数字に変換する
... 変換成功の場合、次の処理を続ける
... 変換失敗の場合、異常に修了する
.. maxResultを計算する

例：

[cols="1,1,1", options="header"]
.TICK データ
|===
|TKTIM
|DPP_T
|DPP

|TKTIM
|DPP_T
|DPP

|===

===== 最小値を取得する処理（ProcessLowData）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func ProcessLowData()

.6+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|listAllData
|QUOTEコードに該当する全てのデータ

|I
|columnData
|DPP、DPR等

|I
|columnTime
|TIME、DPP_T等

|O
|data
|出力データ（安値）

|O
|err
|エラーステータス

1+.^|*機能*
3+|最小値をリターンする。
|===
. dataListをループして、columnTimeの時刻項目でcolumnData項目の最小値を取得する
.. 処理中のアイテムの時刻と処理対象時刻を比較し、対象かどうか判断する。
... 対象の場合、次の処理を続ける
... 対象外の場合、次のループを続ける
.. 処理中のデータを変換する
... 変換済データがNULLではない場合、次の処理を続ける
... 変換済データがNULLである場合、次のループを続ける
.. 数字に変換する
... 変換成功の場合、次の処理を続ける
... 変換失敗の場合、異常に修了する
.. minResultを計算する

===== 始値を取得する処理（ProcessOpenData）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func ProcessOpenData()

.7+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|dataList
|QUOTEコードに該当する全てのデータ

|I
|columnData
|DPP、DPR等

|I
|columnTime
|TIME、DPP_T等

|I
|timeOrderColumnName
|TKTIM、HTKTIM等

|O
|data
|出力データ（始値）

|O
|err
|エラーステータス

1+.^|*機能*
3+|始値をリターンする。
|===
. 基準日付（ZXD）とtimeOrderColumnNameの順番でdataListをループして、columnTimeの時刻項目でcolumnData項目の始値を取得する
.. 処理中のアイテムの時刻と処理対象時刻を比較し、対象かどうか判断する。
... 対象の場合、次の処理を続ける
... 対象外の場合、次のループを続ける
.. 処理中のデータを変換する
... 変換済データがNULLではない場合、次の処理を続ける
... 変換済データがNULLである場合、次のループを続ける
.. 日付と時刻の形式に変換する
... 変換成功の場合、次の処理を続ける
... 変換失敗の場合、異常に修了する
.. 結果を計算する

===== 終値を取得する処理（ProcessCloseData）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func ProcessCloseData()

.6+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|listAllData
|QUOTEコードに該当する全てのデータ

|I
|columnData
|DPP、DPR等

|I
|columnTime
|TIME、DPP_T等

|O
|data
|出力データ（終値）

|O
|err
|エラーステータス

1+.^|*機能*
3+|終値をリターンする。
|===
. 基準日付（ZXD）とtimeOrderColumnNameの順番でdataListをループして、columnTimeの時刻項目でcolumnData項目の終値を取得する
.. 処理中のアイテムの時刻と処理対象時刻を比較し、対象かどうか判断する。
... 対象の場合、次の処理を続ける
... 対象外の場合、次のループを続ける
.. 処理中のデータを変換する
... 変換済データがNULLではない場合、次の処理を続ける
... 変換済データがNULLである場合、次のループを続ける
.. 日付と時刻の形式に変換する
... 変換成功の場合、次の処理を続ける
... 変換失敗の場合、異常に修了する
.. 結果を計算する

===== 合計値を取得する処理（ProcessSumData）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func ProcessSumData()

.6+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|listAllData
|QUOTEコードに該当する全てのデータ

|I
|columnData
|DPP、DPR等

|I
|columnTime
|TIME、DPP_T等

|O
|data
|出力データ（累算値）

|O
|err
|エラーステータス

1+.^|*機能*
3+|合計値をリターンする。
|===
. dataListをループして、columnTimeの時刻項目でcolumnData項目の合計値を取得する
.. 処理中のアイテムの時刻と処理対象時刻を比較し、対象かどうか判断する。
... 対象の場合、次の処理を続ける
... 対象外の場合、次のループを続ける
.. 処理中のデータを変換する
... 変換済データがNULLではない場合、次の処理を続ける
... 変換済データがNULLである場合、次のループを続ける
.. 数字の形式に変換する
... 変換成功の場合、次の処理を続ける
... 変換失敗の場合、異常に修了する
.. sumResultを計算する

===== DFLAGを取得する処理（processDFLAG）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func processDFLAG()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|rawData
|QUOTEコードに該当する全てのデータ

|I
|minute
|対応された分

|O
|flag
|有効データフラグ



1+.^|*機能*
3+|DFLAGをリターンする。
|===
. 日通し現値・価格時刻（DPP_T）が有効 +
日通し現値レート時刻（DPR_T）が有効 +
約定にかかる売買高時刻（XV_T）が有効 +
上記のいずれかが有効なら　　→true +
上記以外の場合　　　　　　　→false +
をセットする。

===== JFLAGを取得する処理（processJFLAG）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func processJFLAG()

.3+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|
|
|

|
|
|

1+.^|*機能*
3+|JFLAGの値を設定する
|===
. TickデータDPS +
""0012""(板寄せ)の場合　→1 +
""0013""(中断)の場合　　→2 +
""0014""(売停)の場合　　→3 +
上記以外の場合　 　　　→0 +
をセットする。

===== DPP・DPRを設定する処理（processDPP）

[cols="1,1,2,4"]
|===

1+|*形式*
3+|func processDPP()

.5+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|listData
|QUOTEコードに該当する全てのデータ

|I
|quoteCode
|QUOTEコード

|I
|tableName
|テーブル名

|O
|listData
|出力データ

1+.^|*機能*
3+|DPP・DPRを設定する処理。
|===

. 全データが同じTKZXDかどうか確認する。
.. 同じの場合、次の処理を行う
.. 同じではない場合、次の処理を行わない。

. DPP処理を行う
.. 同ポケット時刻DPPが存在する場合、それを使って、DOP、DPP、DHP、DLPを設定する。
.. 同ポケット時刻DPPが存在しない場合、XVが存在するかどうかを確認する。
... XVが存在する場合、DPP有りの前の一番近い分間を取得し、この分間のDPPを使って、DOP、DPP、DHP、DLPを設定する
... XVが存在しない場合、DPP処理を飛ばす。

. DPR処理を行う
.. 同ポケット時刻DPRが存在する場合、それを使って、DOR、DPR、DHR、DLRを設定する。
.. 同ポケット時刻DPRが存在しない場合、XVが存在するかどうかを確認する。
... XVが存在する場合、DPR有りの前の一番近い分間を取得し、この分間のDPRを使って、DOR、DPR、DHR、DLRを設定する
... XVが存在しない場合、DPR処理を飛ばす。

==== データ生成・更新（InsertOneMinuteTable）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func InsertOneMinuteTable()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|numberProcess
|QUOTEコード数

|I
|kubun
|QUOTE区分

|I
|hassin
|発信元

1+.^|*機能*
3+|1分足データを登録・更新する。
|===

. データ生成スレッドから受信した1分足レコード数がTK_SYSTEM_BATCH_SIZEになる時、1分足データを登録・更新する
. 登録・更新の結果を確認する
.. 失敗場合、
... 再生成実行回数をチェックする
.... 行回数 < 設定値の場合、リトライして、1分足データを登録・更新する
.... 行回数 = 設定値の場合、エラーログ（ERR006又はERR011）を出力し、異常に終了する。データ生成が失敗の場合、エラーログ（ERR011）を出す。日中足管理テーブル更新失敗の場合、エラーログ（ERR006）を出す。
.. 成功場合、通常に終了する

==== 日中足管理テーブルを更新する（UpdateCandleManagementStatus）
[cols="1,1,2,4"]
|===

1+|*形式*
3+|func UpdateCandleManagementStatus()

.4+.^|*引数*
|*I/O*
|*(型)引数名*
|*解説*

|I
|status
|作成ステータス +
1:　作成中 +
2:　作成成功 +
3:　作成失敗

|I
|candleManagementInfo
|日中足管理情報

|O
|err
|エラーステータス

1+.^|*機能*
3+|日中足管理テーブルに作成ステータスカラムを更新する。
|===

. 日中足管理テーブルの作成ステータスと更新日付カラムを更新するSQLを実行する。日中足管理情報(candleManagementInfo)中には、「TK_TKQKBN」,「TK_SNDC」,「TK_CREATE_DAY」,「TK_OPERATION_TYPE」,「TK_CREATE_TIME」,「TK_START_INDEX」,「TK_FOLDER_PATH」の情報があります。この情報を用いて、日中足管理テーブルの該当レコードを取得し、更新できる。
.. 失敗場合、エラーログ（ERR006）を出力し、異常に終了する
.. 以外場合、正常ログ(INF003)を出力して通常に終了する

== ログ情報出力の共通処理

FireLens（Fluent Bit）でエラーログ、正常ログを分けて指定先のS3バケットへ保存を実現すること。 ログの詳細内容はBP03_メッセージ定義一覧.xlsxに参照する。

image::images/ログ監視.drawio.svg[title="ログ監視",align="center"]

=== アプリケーションログ

正常ログの場合、下記のフォーマットで出力すること。 +
{ +
　　"date": "システム時間", // JST　 +
　　"ServiceName": "BP-03_tck-app-oneminute",　 +
　　"Kei": "X", // 1 or 2+　 +
　　"MessageID": "INF0xx", +
　　"LogType": "TCK_APPLOG", +
　　"Level": "INFO", +
　　"timestamp":ログ発生時点 , +
　　"message":メッセージ情報 , +
　　"ecs_cluster": "ecs_cluster",　// Fluent-bitのFargateタスクのデフォルト項目 +
　　"ecs_task_definition": "ecs_task_definition"　// Fluent-bitのFargateタスクのデフォルト項目 +
}

異常の場合、下記のフォーマットで出力すること。 +
{ +
　　"date": "システム時間", // JST +
　　"ServiceName": "BP-03_tck-app-oneminute", +
　　"Kei": "X", // 1 or 2+ +
　　"MessageID": "ERRxxx", +
　　"LogType": "TCK_APPLOG", +
　　"Level": "ERROR", +
　　"timestamp":ログ発生時点 , +
　　"message":メッセージ情報 , +
　　"ecs_cluster": "ecs_cluster",　// Fluent-bitのFargateタスクのデフォルト項目 +
　　"ecs_task_definition": "ecs_task_definition"　// Fluent-bitのFargateタスクのデフォルト項目 +
}

メッセージ情報：メイン処理のログ出力処理にて指定すること。 +
ログ出力処理：GoLangの共通Functionを利用する。
